name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

permissions:
    contents: read

jobs:
    lint-and-typecheck:
        name: Lint & Typecheck
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
              with:
                  version: 10
            - uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: pnpm
            - run: pnpm install --frozen-lockfile
            - run: pnpm run lint
            - run: pnpm run typecheck

    test:
        name: Test (Node ${{ matrix.node-version }}, ${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                node-version: [20, 22]
                os: [ubuntu-latest, windows-latest, macos-latest]
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
              with:
                  version: 10
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - run: pnpm install --frozen-lockfile
            - run: pnpm run test:coverage

    integration-test:
        name: Integration Test (DCMTK 3.7.0)
        runs-on: ubuntu-latest
        container:
            image: michaelleehobbs/nodejs-dcmtk:dcmtk-3.7.0-nodejs-24.12.0-alpine3.23
        steps:
            - uses: actions/checkout@v4
            - run: corepack enable && corepack prepare pnpm@10 --activate
            - run: pnpm install --frozen-lockfile
            - run: pnpm run test:integration

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: [lint-and-typecheck, test, integration-test]
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
              with:
                  version: 10
            - uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: pnpm
            - run: pnpm install --frozen-lockfile
            - run: pnpm run build
            - run: pnpm run dry-run

    audit:
        name: Security Audit
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
              with:
                  version: 10
            - uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: pnpm
            - run: pnpm install --frozen-lockfile
            - run: pnpm audit --prod
